<div class="sales-container">
  <div class="sales-header">
    <div style="flex-grow: 1;">
      <h1 class="page-title">Nueva Venta</h1>
      <p class="page-subtitle">Complete los datos para registrar una nueva transacción</p>
    </div>
    <%= link_to '← Volver', backstore_sales_path, class: "btn-back" %>
  </div>

  <%= form_with(model: [:backstore, @sale], local: true, class: "sale-form", html: { novalidate: true }, data: { controller: "sales" }) do |form| %>


    <div class="form-grid">
      <!-- Sección Cliente -->
      <div class="form-card client-section">
        <h3 class="card-title">Datos del Cliente</h3>
        <%= form.fields_for :client_attributes, @sale.client || Client.new do |client_form| %>
          <div class="form-group">
            <%= client_form.label :dni, "DNI", class: "form-label" %>
            <%= client_form.text_field :dni, class: "form-input #{'is-invalid' if client_form.object.errors[:dni].any?}", placeholder: "Ingrese DNI" %>
            <% if client_form.object.errors[:dni].any? %>
              <div class="error-message"><%= client_form.object.errors[:dni].join(', ') %></div>
            <% end %>
          </div>
          <div class="form-row">
            <div class="form-group half">
              <%= client_form.label :name, "Nombre", class: "form-label" %>
              <%= client_form.text_field :name, class: "form-input #{'is-invalid' if client_form.object.errors[:name].any?}", placeholder: "Nombre" %>
              <% if client_form.object.errors[:name].any? %>
                <div class="error-message"><%= client_form.object.errors[:name].join(', ') %></div>
              <% end %>
            </div>
            <div class="form-group half">
              <%= client_form.label :surname, "Apellido", class: "form-label" %>
              <%= client_form.text_field :surname, class: "form-input #{'is-invalid' if client_form.object.errors[:surname].any?}", placeholder: "Apellido" %>
              <% if client_form.object.errors[:surname].any? %>
                <div class="error-message"><%= client_form.object.errors[:surname].join(', ') %></div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Sección Productos -->
      <div class="form-card" data-controller="nested-form">
        <h3 class="card-title">Productos</h3>
        
        <div id="sale_products" data-nested-form-target="target">
          <%= form.fields_for :sale_products do |sale_product_form| %>
            <%= render "sale_product_fields", f: sale_product_form %>
          <% end %>
        </div>

        <!-- Plantilla Oculta (La magia ocurre aquí) -->
        <template data-nested-form-target="template">
          <%= form.fields_for :sale_products, SaleProduct.new, child_index: 'NEW_RECORD' do |sale_product_form| %>
            <%= render "sale_product_fields", f: sale_product_form %>
          <% end %>
        </template>

        <!-- Botón Agregar -->
        <div class="add-product-container">
          <button type="button" data-action="nested-form#add" class="btn-secondary">
            + Agregar otro producto
          </button>
        </div>
      </div>

    <div class="form-actions">
      <%= form.submit "Registrar Venta", class: "btn-primary btn-large" %>
    </div>
  <% end %>
</div>

<style>
  .sales-container {
    max-width: 900px;
    margin: 40px auto;
    padding: 0 20px;
    font-family: system-ui, -apple-system, sans-serif;
    color: #334155;
  }

  /* Header */
  .sales-header {
    display: flex;
    justify_content: space-between;
    align_items: center;
    margin-bottom: 40px;
  }

  .page-title {
    font-size: 2rem;
    color: #1a1a1a;
    margin: 0 0 5px 0;
    font-weight: 800;
  }

  .page-subtitle {
    color: #64748b;
    margin: 0;
  }

  .btn-back {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    width: fit-content;
    height: fit-content;
    color: #64748b;
    text-decoration: none;
    font-weight: 500;
    padding: 8px 16px;
    border-radius: 8px;
    background: #f1f5f9;
    transition: all 0.2s;
  }

  .btn-back:hover {
    background: #e2e8f0;
    color: #334155;
  }

  /* Form Layout */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    margin-bottom: 30px;
  }

  .form-card {
    background: white;
    padding: 24px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }

  .card-title {
    font-size: 1rem;
    color: #1a1a1a;
    margin: 0 0 20px 0;
    padding-bottom: 12px;
    border-bottom: 1px solid #f1f5f9;
  }

  /* Inputs */
  .form-group {
    margin-bottom: 16px;
  }

  .form-row {
    display: flex;
    gap: 12px;
  }

  .form-group.half {
    flex: 1;
  }

  .form-label {
    display: block;
    font-size: 0.85rem;
    font-weight: 500;
    color: #64748b;
    margin-bottom: 6px;
  }

  .form-input, .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #0f172a;
    transition: border-color 0.2s;
    box-sizing: border-box; /* Important for padding */
  }

  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* Product Item */
  .product-item {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    background: #f8fafc;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
  }

  .product-select {
    flex-grow: 1;
    margin-bottom: 0;
  }

  .quantity-input {
    margin-bottom: 0;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .quantity-input .form-input {
    width: 80px;
  }

  .quantity-input .error-message {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: max-content;
    background: #fef2f2;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #fecaca;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 4px;
  }

  .quantity-input input,
  .quantity-input input:focus {
    background-color: #ffffff;
    border: 1px solid #cbd5e1;
  }

  .text-center { text-align: center; }

  /* Actions */
  .form-actions {
    text-align: right;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
  }

  .btn-primary {
    background-color: #2563eb;
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
  }

  .btn-primary:hover {
    background-color: #1d4ed8;
  }

  /* Alerts */
  .alert {
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 24px;
  }

  .alert-danger {
    background-color: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  .alert-danger h4 {
    margin: 0 0 8px 0;
    font-size: 1rem;
  }

  .alert-danger ul {
    margin: 0;
    padding-left: 20px;
  }

  .client-section .form-input {
    color: white;
    background-color: #334155; /* Dark slate for contrast */
    border-color: #475569;
  }

  .client-section .form-input::placeholder {
    color: #94a3b8;
  }

  .form-input.is-invalid {
    border-color: #ef4444;
    background-color: #fef2f2;
  }
  
  .client-section .form-input.is-invalid {
    background-color: #450a0a; /* Darker red for dark section */
    border-color: #f87171;
  }

  .error-message {
    color: #ef4444;
    font-size: 0.85rem;
    margin-top: 4px;
    font-weight: 500;
  }
  
  .client-section .error-message {
    color: #fca5a5;
  }
</style>
