<div class="form-container" style="max-width: 800px;">
  <h1 class="form-title">Nuevo Producto</h1>


  <% if @product.errors.any? %>
    <div class="form-errors">
      <h3 class="error-title">No se pudo guardar el producto:</h3>
      <ul class="error-list">
        <% @product.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <%= form_with model: @product, url: backstore_products_path, local: true, class: "user-form", multipart: true do |f| %>
    <div class="form-group">
      <%= f.label :name, "Nombre del Álbum", class: "form-label" %>
      <%= f.text_field :name, class: "form-input", placeholder: "Ej: The Dark Side of the Moon" %>
    </div>
    <div class="form-group">
      <%= f.label :author, "Artista / Banda", class: "form-label" %>
      <%= f.text_field :author, class: "form-input", placeholder: "Ej: Pink Floyd" %>
    </div>
    <div class="grid-2-cols" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <div class="form-group">
        <%= f.label :category, "Género", class: "form-label" %>
        <%= f.select :category, ["Rock", "Pop", "Jazz", "Metal", "Indie", "Clásica"], { prompt: "Selecciona un género" }, class: "form-input" %>
      </div>
      <div class="form-group">
        <%= f.label :type, "Formato", class: "form-label" %>
        <%= f.select :type, ["Vinilo", "CD"], { prompt: "Selecciona formato" }, class: "form-input" %>
      </div>
    </div>
    <div class="form-group">
      <%= f.label :price, "Precio ($)", class: "form-label" %>
      <%= f.number_field :price, class: "form-input", step: 0.01 %>
    </div>
    <div class="form-group">
      <%= f.label :description, "Descripción", class: "form-label" %>
      <%= f.text_area :description, class: "form-input", rows: 4 %>
    </div>
    <div class="form-group" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem; border: 1px solid #374151;">
      <label class="form-label" style="color: #a78bfa; margin-bottom: 1rem; display: block;">Imágenes del Producto (opcional)</label>
      <div id="images-container">
        <%= f.fields_for :images do |image_form| %>
          <div class="image-field" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.375rem;">
            <div style="display: flex; gap: 1rem; align-items: center;">
              <div style="flex: 1;">
                <%= image_form.label :file, "Subir Archivo de Imagen", class: "form-label", style: "font-size: 0.9rem; margin-bottom: 0.5rem;" %>
                <%= image_form.file_field :file, class: "form-input", accept: 'image/png,image/jpeg', style: "margin-top: 0; padding: 0.5rem;" %>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1.5rem;">
                <input type="radio" name="cover_image_index" value="0" style="accent-color: #8b5cf6;">
                <label style="color: #d1d5db; font-size: 0.9rem; white-space: nowrap;">Usar como portada</label>
              </div>
              <button type="button" onclick="removeImageField(this)" class="remove-image-btn" style="margin-top: 1.5rem; padding: 0.5rem; background: #dc2626; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem;">
                ✕
              </button>
            </div>
          </div>
        <% end %>
      </div>
      <button type="button" onclick="addImageField()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #6d28d9; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem;">
        + Agregar otra imagen
      </button>   
      <small style="color: #9ca3af; font-size: 0.85rem; display: block; margin-top: 0.75rem;">
        Puedes subir múltiples archivos. Marca uno como portada.
      </small>
    </div>
    <div class="form-group" style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.5rem; border: 1px solid #374151;">
      <label class="form-label" style="color: #a78bfa; margin-bottom: 1rem; display: block;">Condición del Producto</label>   
      <div style="display: flex; gap: 2rem;">
        <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
          <input type="radio" name="state" value="nuevo" checked onclick="toggleProductType('nuevo')" style="accent-color: #8b5cf6;">
          <span style="color: #d1d5db;">Nuevo (Con stock)</span>
        </label>    
        <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
          <input type="radio" name="state" value="usado" onclick="toggleProductType('usado')" style="accent-color: #8b5cf6;">
          <span style="color: #d1d5db;">Usado (Pieza única)</span>
        </label>
      </div>
    </div>
    <div id="new-product-fields" class="form-group">
      <%= f.fields_for :new_product do |np_form| %>
        <%= np_form.label :stock, "Stock Disponible (Unidades)", class: "form-label" %>
        <%= np_form.number_field :stock, class: "form-input", min: 0 %>
      <% end %>
    </div>
    <div id="used-product-fields" class="form-group" style="display: none;">
      <%= f.fields_for :used_product do |up_form| %>
        <p style="color: #9ca3af; font-size: 0.9rem; font-style: italic; margin-bottom: 1rem;">
          ℹ Los productos usados se registran como pieza única (Stock = 1).
        </p>       
        <%= up_form.fields_for :audio do |audio_form| %>
          <div class="form-group" style="margin-top: 1rem;">
            <%= audio_form.label :file, "Subir Audio de Muestra (MP3)", class: "form-label" %>
            <%= audio_form.file_field :file, class: "form-input", accept: 'audio/mpeg', style: "padding: 0.5rem;" %>
            <small style="color: #9ca3af; font-size: 0.85rem;">Sube un archivo .mp3 para que los clientes escuchen el estado del disco.</small>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="form-actions" style="margin-top: 2rem;">
      <%= f.submit "Guardar Producto", class: "form-submit" %>
      <%= link_to "Cancelar", backstore_products_path, class: "btn-cancel", style: "text-align: center;" %>
    </div>

  <% end %>
</div>

<script>
  let imageFieldCount = 1;
  
  function toggleProductType(type) {
    const newFields = document.getElementById('new-product-fields');
    const usedFields = document.getElementById('used-product-fields');

    if (type === 'nuevo') {
      newFields.style.display = 'block';
      usedFields.style.display = 'none';
    } else {
      newFields.style.display = 'none';
      usedFields.style.display = 'block';
    }
  }

  function addImageField() {
    const container = document.getElementById('images-container');
    const newField = `
      <div class="image-field" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.375rem;">
        <div style="display: flex; gap: 1rem; align-items: center;">
          <div style="flex: 1;">
            <label class="form-label" style="font-size: 0.9rem; margin-bottom: 0.5rem;">Subir Archivo de Imagen</label>
            <input type="file" name="product[images_attributes][${imageFieldCount}][file]" class="form-input" accept="image/png,image/jpeg" style="margin-top: 0; padding: 0.5rem;">
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1.5rem;">
            <input type="radio" name="cover_image_index" value="${imageFieldCount}" style="accent-color: #8b5cf6;">
            <label style="color: #d1d5db; font-size: 0.9rem; white-space: nowrap;">Usar como portada</label>
          </div>
          <button type="button" onclick="removeImageField(this)" class="remove-image-btn" style="margin-top: 1.5rem; padding: 0.5rem; background: #dc2626; color: white; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem;">
            ✕
          </button>
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', newField);
    imageFieldCount++;
    updateRemoveButtons();
  }
  
  function removeImageField(button) {
    const container = document.getElementById('images-container');
    const imageFields = container.querySelectorAll('.image-field');
    
    if (imageFields.length > 1) {
      button.closest('.image-field').remove();
      updateRemoveButtons();
    }
  }
  
  function updateRemoveButtons() {
    const container = document.getElementById('images-container');
    const imageFields = container.querySelectorAll('.image-field');
    const removeButtons = container.querySelectorAll('.remove-image-btn');
    
    removeButtons.forEach(btn => {
      if (imageFields.length <= 1) {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
      }
    });
  }
  
  document.addEventListener('DOMContentLoaded', updateRemoveButtons);
</script>